<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìì—°í˜„ìƒ ì§ê´€ ì„¤ë¬¸ì¡°ì‚¬</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Send, BarChart3, Users, MessageSquare, RefreshCw, Download, Trash2 } = lucide;

        // Supabase ì„¤ì •
        const supabaseUrl = 'https://kcaxstyuejaecdaafijy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjYXhzdHl1ZWphZWNkYWFmaWp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExNzIwNjYsImV4cCI6MjA2Njc0ODA2Nn0.V__xaHzg5hbt2GpIBH1I4CegLx5Fp33cya-Jl93b6hE';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const NatureSurveyApp = () => {
          const [responses, setResponses] = useState([]);
          const [currentQuestion, setCurrentQuestion] = useState('');
          const [currentWhen, setCurrentWhen] = useState('');
          const [showResults, setShowResults] = useState(false);
          const [isSubmitting, setIsSubmitting] = useState(false);
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);

          // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
          const fetchResponses = async () => {
            try {
              setIsLoading(true);
              const { data, error } = await supabase
                .from('survey_response_on_questions')
                .select('*')
                .order('created_at', { ascending: false });

              if (error) throw error;
              setResponses(data || []);
            } catch (err) {
              setError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
              console.error('Error:', err);
            } finally {
              setIsLoading(false);
            }
          };

          // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
          useEffect(() => {
            fetchResponses();
          }, []);

          // ì‘ë‹µ ì œì¶œ
          const handleSubmit = async () => {
            if (!currentQuestion.trim() || !currentWhen.trim()) {
              alert('ë‘ ì§ˆë¬¸ ëª¨ë‘ ë‹µë³€í•´ì£¼ì„¸ìš”!');
              return;
            }

            setIsSubmitting(true);
            
            try {
              const { data, error } = await supabase
                .from('survey_response_on_questions')
                .insert([
                  {
                    questions: currentQuestion.trim(),
                    when_: currentWhen.trim()
                  }
                ])
                .select();

              if (error) throw error;

              // ì„±ê³µ ì‹œ í¼ ì´ˆê¸°í™” ë° ë°ì´í„° ìƒˆë¡œê³ ì¹¨
              setCurrentQuestion('');
              setCurrentWhen('');
              alert('ì‘ë‹µì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
              await fetchResponses(); // ìƒˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
              
            } catch (err) {
              alert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
              console.error('Submit error:', err);
            } finally {
              setIsSubmitting(false);
            }
          };

          // CSV ë‹¤ìš´ë¡œë“œ
          const exportResponses = () => {
            const csvContent = [
              ['ë²ˆí˜¸', 'ìì—°í˜„ìƒ ì§ˆë¬¸', 'ì–¸ì œ ê°–ê²Œ ë˜ì—ˆëŠ”ì§€', 'ì œì¶œ ì‹œê°„'],
              ...responses.map((response, index) => [
                index + 1,
                `"${response.questions}"`,
                `"${response.when_}"`,
                new Date(response.created_at).toLocaleString('ko-KR')
              ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ìì—°í˜„ìƒ_ì„¤ë¬¸ì¡°ì‚¬_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
          };

          return React.createElement('div', {
            className: "min-h-screen bg-gradient-to-br from-blue-50 to-green-50 p-4"
          }, React.createElement('div', {
            className: "max-w-4xl mx-auto"
          }, 
            // í—¤ë”
            React.createElement('div', {
              className: "text-center mb-8"
            }, 
              React.createElement('h1', {
                className: "text-3xl font-bold text-gray-800 mb-2"
              }, "ìì—°í˜„ìƒì— ëŒ€í•œ ì§ê´€ì  ì§ˆë¬¸ ì„¤ë¬¸ì¡°ì‚¬"),
              React.createElement('p', {
                className: "text-gray-600 mb-2"
              }, "ìì—°í˜„ìƒì— ëŒ€í•´ ê°–ê³  ìˆëŠ” ê¶ê¸ˆì¦ê³¼ ê·¸ ì§ˆë¬¸ì„ ì–¸ì œ ê°–ê²Œ ë˜ì—ˆëŠ”ì§€ ì•Œë ¤ì£¼ì„¸ìš”"),
              React.createElement('div', {
                className: "inline-flex items-center px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm"
              }, "âœ¨ ì‹¤ì‹œê°„ ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™")
            ),
            
            error && React.createElement('div', {
              className: "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6"
            }, error),
            
            React.createElement('div', {
              className: "grid lg:grid-cols-2 gap-6"
            },
              // ì„¤ë¬¸ ì–‘ì‹
              React.createElement('div', {
                className: "bg-white rounded-xl shadow-lg p-6"
              },
                React.createElement('div', {
                  className: "flex items-center mb-6"
                },
                  React.createElement(MessageSquare, {
                    className: "text-blue-500 mr-2",
                    size: 24
                  }),
                  React.createElement('h2', {
                    className: "text-xl font-semibold text-gray-800"
                  }, "ì„¤ë¬¸ ì°¸ì—¬")
                ),
                
                React.createElement('div', {
                  className: "space-y-6"
                },
                  React.createElement('div', {},
                    React.createElement('label', {
                      className: "block text-sm font-medium text-gray-700 mb-2"
                    }, "1. ìì—°í˜„ìƒì— ëŒ€í•œ ì§ê´€ì ì¸ ì§ˆë¬¸ì´ ìˆë‚˜ìš”?"),
                    React.createElement('textarea', {
                      value: currentQuestion,
                      onChange: (e) => setCurrentQuestion(e.target.value),
                      placeholder: "ì˜ˆ: ì™œ í•˜ëŠ˜ì€ íŒŒë€ìƒ‰ì¼ê¹Œ?, ìƒˆë“¤ì€ ì–´ë–»ê²Œ ê¸¸ì„ ì°¾ì„ê¹Œ? ë“±",
                      className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",
                      rows: 4,
                      disabled: isSubmitting
                    })
                  ),
                  
                  React.createElement('div', {},
                    React.createElement('label', {
                      className: "block text-sm font-medium text-gray-700 mb-2"
                    }, "2. ì´ ì§ˆë¬¸ì„ ì–¸ì œ ê°–ê²Œ ë˜ì—ˆë‚˜ìš”?"),
                    React.createElement('textarea', {
                      value: currentWhen,
                      onChange: (e) => setCurrentWhen(e.target.value),
                      placeholder: "ì˜ˆ: ì–´ë¦´ ë•Œ í•˜ëŠ˜ì„ ë³´ë©´ì„œ, ìµœê·¼ì— ë‹¤íë©˜í„°ë¦¬ë¥¼ ë³´ë‹¤ê°€, ì‚°ì±…í•˜ë©´ì„œ ë“±",
                      className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",
                      rows: 3,
                      disabled: isSubmitting
                    })
                  ),
                  
                  React.createElement('button', {
                    onClick: handleSubmit,
                    disabled: isSubmitting,
                    className: "w-full bg-blue-500 hover:bg-blue-600 disabled:bg-blue-300 text-white font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center"
                  },
                    isSubmitting && React.createElement('div', {
                      className: "animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-2"
                    }),
                    !isSubmitting && React.createElement(Send, {
                      className: "mr-2",
                      size: 20
                    }),
                    isSubmitting ? 'ì œì¶œ ì¤‘...' : 'ì‘ë‹µ ì œì¶œ'
                  )
                )
              ),
              
              // ê²°ê³¼ í™•ì¸
              React.createElement('div', {
                className: "bg-white rounded-xl shadow-lg p-6"
              },
                React.createElement('div', {
                  className: "flex items-center justify-between mb-6"
                },
                  React.createElement('div', {
                    className: "flex items-center"
                  },
                    React.createElement(BarChart3, {
                      className: "text-green-500 mr-2",
                      size: 24
                    }),
                    React.createElement('h2', {
                      className: "text-xl font-semibold text-gray-800"
                    }, "ì‹¤ì‹œê°„ ì‘ë‹µ")
                  ),
                  React.createElement('div', {
                    className: "flex items-center gap-2"
                  },
                    React.createElement('div', {
                      className: "flex items-center text-sm text-gray-500"
                    },
                      React.createElement(Users, {
                        className: "mr-1",
                        size: 16
                      }),
                      `${responses.length}ëª… ì°¸ì—¬`
                    ),
                    React.createElement('button', {
                      onClick: fetchResponses,
                      disabled: isLoading,
                      className: "p-2 text-gray-500 hover:text-gray-700 disabled:opacity-50"
                    },
                      React.createElement(RefreshCw, {
                        className: isLoading ? "animate-spin" : "",
                        size: 16
                      })
                    )
                  )
                ),

                isLoading ? 
                  React.createElement('div', {
                    className: "text-center py-8"
                  },
                    React.createElement('div', {
                      className: "animate-spin rounded-full h-8 w-8 border-2 border-blue-500 border-t-transparent mx-auto mb-2"
                    }),
                    React.createElement('p', {
                      className: "text-gray-500"
                    }, "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...")
                  ) :
                  responses.length === 0 ? 
                    React.createElement('div', {
                      className: "text-center py-8 text-gray-500"
                    },
                      React.createElement(MessageSquare, {
                        className: "mx-auto mb-3 opacity-50",
                        size: 48
                      }),
                      React.createElement('p', {}, "ì•„ì§ ì œì¶œëœ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤."),
                      React.createElement('p', {
                        className: "text-sm"
                      }, "ì²« ë²ˆì§¸ ì‘ë‹µì„ ë‚¨ê²¨ë³´ì„¸ìš”!")
                    ) :
                    React.createElement('div', {
                      className: "space-y-4"
                    },
                      React.createElement('div', {
                        className: "flex gap-2 mb-4"
                      },
                        React.createElement('button', {
                          onClick: () => setShowResults(!showResults),
                          className: "px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm transition-colors"
                        }, showResults ? 'ì‘ë‹µ ìˆ¨ê¸°ê¸°' : 'ì‘ë‹µ ë³´ê¸°'),
                        React.createElement('button', {
                          onClick: exportResponses,
                          className: "px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm transition-colors flex items-center"
                        },
                          React.createElement(Download, {
                            className: "mr-1",
                            size: 14
                          }),
                          "CSV ë‹¤ìš´ë¡œë“œ"
                        )
                      ),
                      
                      showResults && React.createElement('div', {
                        className: "max-h-96 overflow-y-auto space-y-4"
                      }, responses.map((response, index) =>
                        React.createElement('div', {
                          key: response.id,
                          className: "border border-gray-200 rounded-lg p-4"
                        },
                          React.createElement('div', {
                            className: "flex justify-between items-start mb-2"
                          },
                            React.createElement('span', {
                              className: "text-sm font-medium text-blue-600"
                            }, `ì‘ë‹µ #${index + 1}`),
                            React.createElement('span', {
                              className: "text-xs text-gray-500"
                            }, new Date(response.created_at).toLocaleString('ko-KR'))
                          ),
                          React.createElement('div', {
                            className: "space-y-2"
                          },
                            React.createElement('div', {},
                              React.createElement('p', {
                                className: "text-sm font-medium text-gray-700"
                              }, "ì§ˆë¬¸:"),
                              React.createElement('p', {
                                className: "text-gray-800 bg-gray-50 p-2 rounded"
                              }, response.questions)
                            ),
                            React.createElement('div', {},
                              React.createElement('p', {
                                className: "text-sm font-medium text-gray-700"
                              }, "ì–¸ì œ:"),
                              React.createElement('p', {
                                className: "text-gray-800 bg-gray-50 p-2 rounded"
                              }, response.when_)
                            )
                          )
                        )
                      ))
                    )
              )
            ),
            
            // í†µê³„ ìš”ì•½
            responses.length > 0 && React.createElement('div', {
              className: "mt-6 bg-white rounded-xl shadow-lg p-6"
            },
              React.createElement('h3', {
                className: "text-lg font-semibold text-gray-800 mb-4"
              }, "ì‹¤ì‹œê°„ í†µê³„"),
              React.createElement('div', {
                className: "grid grid-cols-1 md:grid-cols-3 gap-4"
              },
                React.createElement('div', {
                  className: "bg-blue-50 p-4 rounded-lg"
                },
                  React.createElement('p', {
                    className: "text-sm text-blue-600 font-medium"
                  }, "ì´ ì‘ë‹µ ìˆ˜"),
                  React.createElement('p', {
                    className: "text-2xl font-bold text-blue-800"
                  }, responses.length)
                ),
                React.createElement('div', {
                  className: "bg-green-50 p-4 rounded-lg"
                },
                  React.createElement('p', {
                    className: "text-sm text-green-600 font-medium"
                  }, "í‰ê·  ì§ˆë¬¸ ê¸¸ì´"),
                  React.createElement('p', {
                    className: "text-2xl font-bold text-green-800"
                  }, `${Math.round(responses.reduce((acc, r) => acc + r.questions.length, 0) / responses.length)}ì`)
                ),
                React.createElement('div', {
                  className: "bg-purple-50 p-4 rounded-lg"
                },
                  React.createElement('p', {
                    className: "text-sm text-purple-600 font-medium"
                  }, "ìµœê·¼ ì‘ë‹µ"),
                  React.createElement('p', {
                    className: "text-sm font-bold text-purple-800"
                  }, responses.length > 0 ? new Date(responses[0].created_at).toLocaleString('ko-KR').split(' ')[1] : '-')
                )
              )
            ),

            // í‘¸í„°
            React.createElement('div', {
              className: "mt-8 text-center text-sm text-gray-500"
            },
              React.createElement('p', {}, "ğŸŒ¿ Supabaseë¡œ êµ¬ë™ë˜ëŠ” ì‹¤ì‹œê°„ ì„¤ë¬¸ì¡°ì‚¬"),
              React.createElement('p', {}, "ëª¨ë“  ì‘ë‹µì€ ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤")
            )
          ));
        };

        ReactDOM.render(React.createElement(NatureSurveyApp), document.getElementById('root'));
    </script>
</body>
</html>
